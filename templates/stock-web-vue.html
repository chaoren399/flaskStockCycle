<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黄金周期图</title>
    <script src="{{ url_for('static', filename='lib/echarts.min.js') }}"></script>
    <script src="{{ url_for('static', filename='lib/papaparse.min.js') }}"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #0a0a0a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 8px 16px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #2a2a2a;
        }

        .nav-btn.active {
            background: #3a3a3a;
            border-color: #555;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .market-select {
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            border-radius: 4px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        #chart {
            width: 100%;
            height: 600px;
            background: #0a0a0a;
        }

        .company-names {
            margin-top: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            font-size: 14px;
            display: none;
        }

        .company-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            background: #2a2a2a;
            border-radius: 4px;
            min-width: 100px;
        }

        .company-date {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .company-name {
            color: #fff;
            font-size: 13px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nav-buttons">
                <button class="nav-btn" id="btn-full-time">整时间</button>
                <button class="nav-btn active" id="btn-line">线型图</button>
                <button class="nav-btn" id="btn-step">阶梯图</button>
            </div>
            <div class="header-right">
                <select class="market-select" id="market-select">
                    <option value="all">市场选择</option>
                </select>
                <label class="checkbox-label">
                    <input type="checkbox" id="strategy-checkbox">
                    <span>黄金周期图实战策略讲解</span>
                </label>
            </div>
        </div>
        <div id="chart"></div>
        <div class="company-names" id="company-names"></div>
    </div>

    <script>
        let chartData = [];
        let chartInstance = null;

        // 加载CSV数据
     // 加载JSON格式数据
async function loadData() {
    try {
        // 使用JSON格式的API接口
        const response = await fetch("/api/chart-data/json");
        const result = await response.json();

        if (result.status === "success") {
            chartData = result.data
                .filter(row => row.日期 && row.日期.trim())
                .reverse();

            initChart();
            updateCompanyNames();
        } else {
            console.error('加载数据失败:', result.message);
        }
    } catch (error) {
        console.error('加载数据失败:', error);
    }
}


        // 初始化图表
        function initChart() {
            const chartDom = document.getElementById('chart');
            chartInstance = echarts.init(chartDom, 'dark');

            const dates = chartData.map(row => {
                let dateStr = row.日期;
                // 处理日期格式：2025年11月11日 -> 2025-11-11
                dateStr = dateStr.replace('年', '-').replace('月', '-').replace('日', '');
                // 确保月份和日期是两位数
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const month = parts[1].padStart(2, '0');
                    const day = parts[2].padStart(2, '0');
                    dateStr = `${parts[0]}-${month}-${day}`;
                }
                return dateStr;
            });

            // 创建日期到股票名称的映射
            const dateToCompanies = {};
            chartData.forEach((row, idx) => {
                // 格式化日期作为key
                let dateStr = row.日期;
                dateStr = dateStr.replace('年', '-').replace('月', '-').replace('日', '');
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const month = parts[1].padStart(2, '0');
                    const day = parts[2].padStart(2, '0');
                    dateStr = `${parts[0]}-${month}-${day}`;
                }

                // 提取股票名称
                const companies = [];
                if (row.其他) {
                    const parts = row.其他.split('-');
                    parts.forEach(part => {
                        const trimmed = part.trim();
                        // 简单过滤：排除明显不是股票名称的内容
                        if (trimmed &&
                            trimmed.length >= 2 &&
                            !trimmed.match(/^玫瑰|持有|空仓|关注|卖出|成仓|被关|出关|第\d+天|节点|喝茶|动作|百股|跌停|冰点|等待|龙头|止跌|释放|资金|流动性|开盘|梦天|家居|\d+板|合肥|城建|S.*|^\d+$/) &&
                            !trimmed.includes('玫瑰') &&
                            !trimmed.includes('持有') &&
                            !trimmed.includes('空仓') &&
                            !trimmed.includes('关注') &&
                            !trimmed.includes('卖出')) {
                            companies.push(trimmed);
                        }
                    });
                }
                dateToCompanies[dateStr] = companies;
            });

            // 调试：输出前几个日期和对应的股票名称
            console.log('日期到股票名称映射示例:', Object.keys(dateToCompanies).slice(0, 5).map(d => ({date: d, companies: dateToCompanies[d]})));

            const riseRatio = chartData.map(row => parseFloat(row.上涨比率) || 0);
            const pressureHeight = chartData.map(row => parseInt(row.压力高度) || 0); // 橙色线
            const maxBoard = chartData.map(row => parseInt(row.最高板) || 0); // 紫色虚线
            const overallSentiment = chartData.map(row => parseInt(row.大面数) || 0); // 大面情绪
            const strongSentiment = chartData.map(row => parseInt(row.大肉情绪) || 0); // 大肉情绪
            const consecutiveBoards = chartData.map(row => parseInt(row.连板数) || 0); // 连板数
            const sentimentValue = chartData.map(row => parseFloat(row.情绪值) || 0); // 情绪值

            const option = {
                backgroundColor: 'transparent',
                grid: {
                    left: '1%',
                    right: '3%',
                    top: '15%',
                    bottom: '25%',
                    containLabel: false
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    borderColor: '#555',
                    textStyle: {
                        color: '#fff'
                    }
                },
                // legend 只修改配置默认显示2个：压力高度、最高板
                 legend: {
        data: ['上涨比率', '大面情绪', '大肉情绪', '连板数', '情绪值', '压力高度', '最高板'],
        top: 10,
        left: 'center',
        textStyle: {
            color: '#fff',
            fontSize: 12
        },
        itemGap: 30,
        icon: 'circle',
        itemWidth: 10,
        itemHeight: 10,
        selected: {                         // 添加默认选中配置
            '上涨比率': false,              // 默认隐藏
            '大面情绪': false,              // 默认隐藏
            '大肉情绪': false,              // 默认隐藏
            '连板数': false,                // 默认隐藏
            '情绪值': false,                // 默认隐藏
            '压力高度': true,               // 默认显示
            '最高板': true                  // 默认显示
        }
    },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dates,
                    axisLine: {
                        lineStyle: {
                            color: '#555'
                        }
                    },
                    axisLabel: {
                        color: '#aaa',
                        rotate: -15, // 稍微旋转，避免重叠
                        interval: 0, // 显示所有标签，不隐藏
                        formatter: function(value, index) {
                            // 根据日期值查找对应的股票名称
                            const companies = dateToCompanies[value] || [];
                            // 调试：检查是否有数据
                            if (index < 5) {
                                console.log(`日期: ${value}, 索引: ${index}, 股票名称:`, companies);
                            }
                            if (companies && companies.length > 0) {
                                // 日期显示在上方，股票名称显示在下方，每个股票名称换行显示
                                const displayName = companies.join('\n');
                                // 使用rich文本格式
                                return '{date|' + value + '}\n{stock|' + displayName + '}';
                            }
                            // 如果没有股票名称，只显示日期
                            return value;
                        },
                        rich: {
                            date: {
                                color: '#888',
                                fontSize: 9,
                                lineHeight: 12
                            },
                            stock: {
                                color: '#fff',
                                fontSize: 10,
                                fontWeight: 'bold',
                                lineHeight: 14
                            }
                        },
                        lineHeight: 14,
                        margin: 15,
                        overflow: 'none' // 不隐藏溢出标签
                    }
                },
                <!-- 修改 yAxis 配置  控制 Y轴高度 -->
yAxis: {
    type: 'value',
    min: 0,
    max: 20,           // 将最大值设置为20
    interval: 2,       // 调整间隔以适应新的范围
    axisLine: {
        lineStyle: {
            color: '#555'
        }
    },
    axisLabel: {
        color: '#aaa'
    },
    splitLine: {
        show: true,
        lineStyle: {
            color: '#222',
            type: 'dashed'
        }
    }
},

// 在 initChart() 函数中的 option 对象里的 dataZoom 配置部分修改为：
dataZoom: [
    {
        type: 'slider',
        show: true,
        xAxisIndex: [0],
        start: Math.max(0, ((dates.length - 20) / dates.length) * 100), // 默认显示最近20天
        end: 100,
        bottom: 10,
        height: 30,
        handleIcon: 'path://M30.9,53.2C16.8,53.2,5.3,41.7,5.3,27.6S16.8,2,30.9,2C45,2,56.4,13.5,56.4,27.6S45,53.2,30.9,53.2z M30.9,3.5C17.6,3.5,6.8,14.4,6.8,27.6c0,13.3,10.8,24.1,24.1,24.1C44.2,51.7,55,40.9,55,27.6C54.9,14.4,44.1,3.5,30.9,3.5z M36.9,35.8c0,0.6-0.4,1-1,1H26.8c-0.6,0-1-0.4-1-1V19.5c0-0.6,0.4-1,1-1h9.2c0.6,0,1,0.4,1,1V35.8z',
        handleSize: '80%',
        handleStyle: {
            color: '#fff',
            borderColor: '#555'
        },
        textStyle: {
            color: '#aaa',
            fontSize: 12
        },
        borderColor: '#555',
        fillerColor: 'rgba(255, 255, 255, 0.1)',
        dataBackground: {
            lineStyle: {
                color: '#888'
            },
            areaStyle: {
                color: 'rgba(255, 255, 255, 0.05)'
            }
        },
        selectedDataBackground: {
            lineStyle: {
                color: '#FFD700'
            },
            areaStyle: {
                color: 'rgba(255, 215, 0, 0.2)'
            }
        }
    },
    {
        type: 'inside',
        xAxisIndex: [0],
        start: Math.max(0, ((dates.length - 20) / dates.length) * 100), // 默认显示最近20天
        end: 100
    }
],

                series: [
                    {
                        name: '上涨比率',
                        type: 'line',
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0,
                                    color: 'rgba(255, 215, 0, 0.6)'
                                }, {
                                    offset: 1,
                                    color: 'rgba(255, 215, 0, 0.1)'
                                }]
                            }
                        },
                        lineStyle: {
                            color: '#FFD700',
                            width: 2
                        },
                        itemStyle: {
                            color: '#FFD700'
                        },
                        data: riseRatio,
                        symbol: 'circle',
                        symbolSize: 6,
                        smooth: true
                    },
                    {
                        name: '大面情绪',
                        type: 'line',
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0,
                                    color: 'rgba(255, 255, 255, 0.4)'
                                }, {
                                    offset: 1,
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }]
                            }
                        },
                        lineStyle: {
                            color: '#fff',
                            width: 2
                        },
                        itemStyle: {
                            color: '#fff'
                        },
                        data: overallSentiment.map(val => val / 10), // 缩放以适配0-80范围
                        symbol: 'circle',
                        symbolSize: 6,
                        smooth: true
                    },
                    {
                        name: '压力高度',
                        type: 'line',
                        lineStyle: {
                            color: '#FF8C00',
                            width: 3
                        },
                        itemStyle: {
                            color: '#FF8C00'
                        },
                        data: pressureHeight,
                        symbol: 'circle',
                        symbolSize: 12,
                        label: {
                            show: true,
                            position: 'top',
                            color: '#fff',
                            fontSize: 12,
                            fontWeight: 'bold',
                            formatter: function(params) {
                                return params.value;
                            }
                        },
                        smooth: true
                    },
                    {
                        name: '最高板',
                        type: 'line',
                        lineStyle: {
                            color: '#9370DB',
                            width: 2,
                            type: 'dashed'
                        },
                        itemStyle: {
                            color: '#9370DB'
                        },
                        data: maxBoard,
                        symbol: 'circle',
                        symbolSize: 12,
                        label: {
                            show: true,
                            position: 'top',
                            color: '#fff',
                            fontSize: 12,
                            fontWeight: 'bold',
                            formatter: function(params) {
                                return params.value;
                            }
                        },
                        smooth: true
                    },
                    {
                        name: '大肉情绪',
                        type: 'line',
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0,
                                    color: 'rgba(255, 165, 0, 0.4)'
                                }, {
                                    offset: 1,
                                    color: 'rgba(255, 165, 0, 0.1)'
                                }]
                            }
                        },
                        lineStyle: {
                            color: '#FFA500',
                            width: 2
                        },
                        itemStyle: {
                            color: '#FFA500'
                        },
                        data: strongSentiment.map(val => val / 10), // 缩放以适配0-80范围
                        symbol: 'circle',
                        symbolSize: 6,
                        smooth: true
                    },
                    {
                        name: '连板数',
                        type: 'line',
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0,
                                    color: 'rgba(155, 89, 182, 0.4)'
                                }, {
                                    offset: 1,
                                    color: 'rgba(155, 89, 182, 0.1)'
                                }]
                            }
                        },
                        lineStyle: {
                            color: '#9B59B6',
                            width: 2
                        },
                        itemStyle: {
                            color: '#9B59B6'
                        },
                        data: consecutiveBoards.map(val => {
                            // 连板数范围大约在9-25之间，映射到0-80范围
                            const min = 9;
                            const max = 25;
                            return Math.max(0, Math.min(80, ((val - min) / (max - min)) * 80));
                        }),
                        symbol: 'circle',
                        symbolSize: 6,
                        smooth: true
                    },
                    {
                        name: '情绪值',
                        type: 'line',
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0,
                                    color: 'rgba(255, 0, 0, 0.4)'
                                }, {
                                    offset: 1,
                                    color: 'rgba(255, 0, 0, 0.1)'
                                }]
                            }
                        },
                        lineStyle: {
                            color: '#FF0000',
                            width: 2
                        },
                        itemStyle: {
                            color: '#FF0000'
                        },
                        data: sentimentValue.map(val => Math.abs(val) / 10), // 缩放以适配0-80范围
                        symbol: 'circle',
                        symbolSize: 6,
                        smooth: true
                    }
                ]
            };

            // 添加水平参考线（20的位置）
            option.graphic = [{
                type: 'line',
                left: '10%',
                right: '10%',
                top: '15%',
                bottom: '25%',
                shape: {
                    x1: 0,
                    y1: (80 - 20) / 80,
                    x2: 1,
                    y2: (80 - 20) / 80
                },
                style: {
                    stroke: '#90EE90',
                    lineDash: [5, 5],
                    lineWidth: 1,
                    opacity: 0.5
                },
                z: 100
            }];

            // 找到冰点日期（2025-11-21）的索引并添加标记
            const icePointIndex = dates.findIndex(d => d === '2025-11-21');
            if (icePointIndex !== -1 && riseRatio[icePointIndex] !== undefined) {
                // 使用markPoint添加冰点标记
                option.series[0].markPoint = {
                    data: [{
                        coord: [icePointIndex, riseRatio[icePointIndex]],
                        symbol: 'pin',
                        symbolSize: 30,
                        itemStyle: {
                            color: '#00BFFF'
                        },
                        label: {
                            show: true,
                            formatter: '❄',
                            fontSize: 20,
                            color: '#00BFFF',
                            position: 'top'
                        }
                    }]
                };
            }

            chartInstance.setOption(option);

            // 监听 dataZoom 事件，更新底部股票名称显示
            chartInstance.on('datazoom', function(params) {
                const startPercent = params.start || 0;
                const endPercent = params.end || 100;
                updateCompanyNames(startPercent, endPercent);
            });
        }

        // 更新公司名称显示（根据当前可见时间段，每个日期对应股票名称）
        function updateCompanyNames(startPercent = 0, endPercent = 100) {
            const container = document.getElementById('company-names');
            container.innerHTML = '';

            // 计算可见的数据范围
            const totalData = chartData.length;
            const startIndex = Math.floor((startPercent / 100) * totalData);
            const endIndex = Math.ceil((endPercent / 100) * totalData);
            const visibleData = chartData.slice(startIndex, endIndex);

            // 显示每个日期和对应的股票名称
            visibleData.forEach(row => {
                // 格式化日期
                let dateStr = row.日期;
                dateStr = dateStr.replace('年', '-').replace('月', '-').replace('日', '');
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const month = parts[1].padStart(2, '0');
                    const day = parts[2].padStart(2, '0');
                    dateStr = `${parts[0]}-${month}-${day}`;
                }

                // 处理公司名称
                let companies = [];
                if (row.其他) {
                    companies = row.其他.split(/[-、]/)
                        .filter(c => c.trim() && !c.includes('玫瑰') && !c.includes('持有') && !c.includes('空仓') && !c.includes('关注') && !c.includes('卖出'));
                }

                // 创建日期和股票名称的显示项
                const item = document.createElement('div');
                item.className = 'company-item';

                const dateSpan = document.createElement('div');
                dateSpan.className = 'company-date';
                dateSpan.textContent = dateStr;

                const nameSpan = document.createElement('div');
                nameSpan.className = 'company-name';
                nameSpan.textContent = companies.length > 0 ? companies.join('、') : '-';

                item.appendChild(dateSpan);
                item.appendChild(nameSpan);
                container.appendChild(item);
            });
        }

        // 导航按钮事件
        document.getElementById('btn-full-time').addEventListener('click', function() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            // 这里可以添加加载全部时间数据的逻辑
        });

        document.getElementById('btn-line').addEventListener('click', function() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            // 切换为线型图
            if (chartInstance) {
                const option = chartInstance.getOption();
                option.series.forEach(series => {
                    if (series.type === 'line') {
                        series.smooth = true;
                    }
                });
                chartInstance.setOption(option);
            }
        });

        document.getElementById('btn-step').addEventListener('click', function() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            // 切换为阶梯图
            if (chartInstance) {
                const option = chartInstance.getOption();
                option.series.forEach(series => {
                    if (series.type === 'line') {
                        series.step = 'end';
                        series.smooth = false;
                    }
                });
                chartInstance.setOption(option);
            }
        });

        // 窗口大小改变时调整图表
        window.addEventListener('resize', function() {
            if (chartInstance) {
                chartInstance.resize();
            }
        });

        // 加载数据
        loadData();
    </script>
</body>
</html>
